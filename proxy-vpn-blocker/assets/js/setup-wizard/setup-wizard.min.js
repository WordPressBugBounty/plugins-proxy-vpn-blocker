!function(){let currentStep=0,lastHeight=0;const form=document.getElementById("pvb-setup-form"),steps=form.querySelectorAll(".pvb-step");function calculateVisibleHeight(element){return new Promise(resolve=>{setTimeout(()=>{const originalMaxHeight=element.style.maxHeight,originalHeight=element.style.height;element.style.maxHeight="none",element.style.height="auto",element.offsetHeight;const naturalHeight=element.scrollHeight;element.style.maxHeight=originalMaxHeight,element.style.height=originalHeight,resolve(naturalHeight+20)},100)})}async function adjustWrapperHeight(){const wrapper=document.querySelector(".pvb-steps-wrapper"),activeStep=wrapper&&wrapper.querySelector(".pvb-step.active");if(!wrapper||!activeStep)return;const scrollTop=window.pageYOffset||document.documentElement.scrollTop,currentHeight=wrapper.offsetHeight;wrapper.style.height=currentHeight+"px",wrapper.offsetHeight;const targetHeight=await calculateVisibleHeight(activeStep);requestAnimationFrame(()=>{wrapper.style.height=targetHeight+"px",setTimeout(()=>{window.scrollTo(0,scrollTop)},50)})}function toggleDetails(button){let content=button.nextElementSibling;if(!content||!content.classList.contains("details-content")){const container=button.closest(".pvb-field-wrapper")||button.closest(".pvb-option")||button.closest(".option-header")||button.parentNode;content=container.querySelector(".details-content")}if(!content){const allContent=document.querySelectorAll(".details-content"),buttonIndex=Array.from(document.querySelectorAll(".details-toggle")).indexOf(button);content=allContent[buttonIndex]}if(!content)return void console.warn("Could not find details content for toggle button:",button);const chevron=button.querySelector(".chevron"),buttonText=button.querySelector("span"),isOpen=content.classList.contains("open");isOpen?(content.classList.remove("open"),chevron&&chevron.classList.remove("rotated"),buttonText&&(buttonText.textContent="View details")):(content.classList.add("open"),chevron&&chevron.classList.add("rotated"),buttonText&&(buttonText.textContent="Hide details")),setTimeout(()=>{adjustWrapperHeight()},150)}function validateCurrentStep(){const currentStepElement=steps[currentStep],requiredFields=currentStepElement.querySelectorAll("input[required], select[required], textarea[required]");let isValid=!0,firstInvalidField=null;return requiredFields.forEach(field=>{const value=field.value.trim(),isFieldValid=""!==value;if(isFieldValid){field.classList.remove("pvb-field-error");const errorMsg=field.parentNode.querySelector(".pvb-error-message");errorMsg&&(errorMsg.style.display="none")}else{isValid=!1,firstInvalidField||(firstInvalidField=field),field.classList.add("pvb-field-error");let errorMsg=field.parentNode.querySelector(".pvb-error-message");errorMsg||(errorMsg=document.createElement("div"),errorMsg.className="pvb-error-message",errorMsg.style.color="#d63638",errorMsg.style.fontSize="14px",errorMsg.style.marginTop="5px",field.parentNode.appendChild(errorMsg)),errorMsg.textContent="This field is required",errorMsg.style.display="block"}}),!isValid&&firstInvalidField&&firstInvalidField.focus(),isValid}function clearValidationErrors(stepElement){const errorFields=stepElement.querySelectorAll(".pvb-field-error"),errorMessages=stepElement.querySelectorAll(".pvb-error-message");errorFields.forEach(field=>field.classList.remove("pvb-field-error")),errorMessages.forEach(msg=>msg.style.display="none")}function updateNavigationButtons(step){const prevBtn=form.querySelector("[data-prev]"),nextBtn=form.querySelector("[data-next]"),skipBtn=form.querySelector("[data-skip]"),finishBtn=form.querySelector('[type="submit"]');prevBtn.style.display=0===step?"none":"inline-block",nextBtn.style.display=step===steps.length-1?"none":"inline-block",skipBtn.style.display=0===step?"inline-block":"none",finishBtn.style.display=step===steps.length-1?"inline-block":"none"}function updateProgressBar(index){const fill=document.querySelector(".pvb-progress-bar-fill"),percentText=document.querySelector(".pvb-progress-percent"),percent=Math.round(index/(steps.length-1)*100);fill.style.width=`${percent}%`,percentText.textContent=`${percent}% Complete`}function updateURL(stepIndex){const url=new URL(window.location);url.searchParams.set("step",stepIndex+1),window.history.pushState({step:stepIndex},"",url.toString())}function getStepFromURL(){const urlParams=new URLSearchParams(window.location.search),stepParam=urlParams.get("step");if(stepParam){const stepIndex=parseInt(stepParam)-1;return Math.max(0,Math.min(stepIndex,steps.length-1))}return 0}function updateStepClasses(newIndex){const wrapper=document.querySelector(".pvb-steps-wrapper");steps.forEach((step,i)=>{step.classList.remove("active"),i!==newIndex&&step.classList.add("hidden"),step.style.zIndex=i===newIndex?2:1});const nextStep=steps[newIndex];nextStep.classList.add("active"),nextStep.classList.remove("hidden"),updateProgressBar(newIndex),updateNavigationButtons(newIndex),updateURL(newIndex),setTimeout(()=>{adjustWrapperHeight()},50),currentStep=newIndex}function enableWrapperTransition(){const wrapper=document.querySelector(".pvb-steps-wrapper");wrapper&&(wrapper.style.transition="height 0.4s ease",wrapper.style.overflow="hidden")}function initializeSteps(){currentStep=getStepFromURL(),steps.forEach((step,i)=>{step.classList.remove("active"),i!==currentStep&&step.classList.add("hidden"),step.style.zIndex=i===currentStep?2:1});const activeStep=steps[currentStep];activeStep.classList.add("active"),activeStep.classList.remove("hidden"),updateProgressBar(currentStep),updateNavigationButtons(currentStep);const wrapper=document.querySelector(".pvb-steps-wrapper");if(wrapper&&activeStep){wrapper.style.transition="none",wrapper.style.overflow="hidden";const originalMaxHeight=activeStep.style.maxHeight,originalHeight=activeStep.style.height;activeStep.style.maxHeight="none",activeStep.style.height="auto",activeStep.offsetHeight;const naturalHeight=activeStep.scrollHeight+20;activeStep.style.maxHeight=originalMaxHeight,activeStep.style.height=originalHeight,wrapper.style.height=naturalHeight+"px",setTimeout(()=>{wrapper.style.transition="height 0.4s ease"},100)}}function showNotification(message,type="success"){const notification=document.createElement("div");notification.className=`pvb-notification pvb-notification-${type}`,notification.style.cssText=`\n            position: fixed;\n            top: 32px;\n            right: 20px;\n            background: ${"success"===type?"#46b450":"#d63638"};\n            color: white;\n            padding: 12px 20px;\n            border-radius: 4px;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n            z-index: 999999;\n            font-size: 14px;\n            max-width: 400px;\n        `,notification.textContent=message,document.body.appendChild(notification),setTimeout(()=>{notification.parentNode&&notification.parentNode.removeChild(notification)},5e3)}function collectFormData(){const formData=new FormData(form),data=new URLSearchParams;data.append("action","pvb_complete_setup"),data.append("nonce",pvb_setup_wizard.nonce);for(let[key,value]of formData.entries())data.append(key,value);const toggleFields=["pvb_proxycheckio_VPN_select_box","pvb_proxycheckio_risk_select_box","pvb_log_user_ip_select_box","pvb_cache_buster"];return toggleFields.forEach(fieldName=>{const field=form.querySelector(`[name="${fieldName}"]`);field&&("checkbox"===field.type||field.classList.contains("toggle-switch"))&&(field.checked||field.classList.contains("active")||"on"===field.value?data.set(fieldName,"on"):data.set(fieldName,""))}),data}function handleSkipSetup(){const skipBtn=form.querySelector("[data-skip]"),originalText=skipBtn.textContent;skipBtn.textContent="Skipping...",skipBtn.disabled=!0;const data=new URLSearchParams;data.append("action","pvb_skip_setup"),data.append("nonce",pvb_setup_wizard.nonce),fetch(pvb_setup_wizard.ajax_url,{method:"POST",body:data,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(response=>response.json()).then(result=>{result.success?(showNotification(result.data.message,"success"),setTimeout(()=>{window.location.href=result.data.redirect_url},1e3)):(showNotification(result.data.message||"An error occurred while skipping setup.","error"),skipBtn.textContent=originalText,skipBtn.disabled=!1)}).catch(error=>{console.error("Skip setup error:",error),showNotification("An error occurred while skipping setup.","error"),skipBtn.textContent=originalText,skipBtn.disabled=!1})}function handleFormSubmission(){if(!validateCurrentStep())return;const submitBtn=form.querySelector('[type="submit"]'),originalText=submitBtn.textContent;submitBtn.textContent="Completing Setup...",submitBtn.disabled=!0;const data=collectFormData();fetch(pvb_setup_wizard.ajax_url,{method:"POST",body:data,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(response=>response.json()).then(result=>{result.success?(showNotification(result.data.message,"success"),setTimeout(()=>{window.location.href=result.data.redirect_url},1e3)):(showNotification(result.data.message||"An error occurred while completing setup.","error"),submitBtn.textContent=originalText,submitBtn.disabled=!1)}).catch(error=>{console.error("Setup completion error:",error),showNotification("An error occurred while completing setup.","error"),submitBtn.textContent=originalText,submitBtn.disabled=!1})}window.addEventListener("popstate",(function(e){if(e.state&&"number"==typeof e.state.step){const targetStep=e.state.step;targetStep>=0&&targetStep<steps.length&&updateStepClasses(targetStep)}else{const urlStep=getStepFromURL();urlStep!==currentStep&&updateStepClasses(urlStep)}})),form.addEventListener("click",(function(e){if(e.target.matches("[data-next]")){if(e.preventDefault(),!validateCurrentStep())return;currentStep<steps.length-1&&(clearValidationErrors(steps[currentStep+1]),updateStepClasses(currentStep+1))}e.target.matches("[data-prev]")&&(e.preventDefault(),currentStep>0&&(clearValidationErrors(steps[currentStep-1]),updateStepClasses(currentStep-1))),e.target.matches("[data-skip]")&&(e.preventDefault(),handleSkipSetup()),e.target.closest(".details-toggle")&&(e.preventDefault(),toggleDetails(e.target.closest(".details-toggle")))})),form.addEventListener("submit",(function(e){e.preventDefault(),handleFormSubmission()})),window.addEventListener("load",()=>{requestAnimationFrame(()=>{setTimeout(()=>{initializeSteps()},50)})})}();